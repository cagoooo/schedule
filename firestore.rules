rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /bookings/{booking} {
      // 所有人可讀取預約資料
      allow read: if true;
      
      // 新增預約：完整欄位驗證
      allow create: if isValidBooking();
      
      // 更新：需要已登入的管理員 或 持有正確 deviceId 的使用者 (自刪)
      allow update: if request.auth != null || (resource.data.deviceId == request.resource.data.deviceId);
      
      // 刪除：仍僅限管理員
      allow delete: if request.auth != null;
      
      // ===== 驗證函數 =====
      function isValidBooking() {
        let data = request.resource.data;
        return 
          // 必填欄位存在性
          data.keys().hasAll(['booker', 'date', 'periods', 'reason'])
          // 欄位數量限制（防止惡意欄位注入）
          && data.keys().size() <= 8
          // booker 驗證：字串、非空、長度限制
          && data.booker is string
          && data.booker.size() >= 1
          && data.booker.size() <= 50
          // room 驗證：字串、長度限制
          && (!('room' in data.keys()) || (data.room is string && data.room.size() <= 50))
          // date 驗證：字串、格式 YYYY/MM/DD
          && data.date is string
          && data.date.matches('^[0-9]{4}/[0-9]{2}/[0-9]{2}$')
          // periods 驗證：陣列、非空、最多10個節次
          && data.periods is list
          && data.periods.size() >= 1
          && data.periods.size() <= 10
          // reason 驗證：字串、長度限制
          && data.reason is string
          && data.reason.size() <= 200
          // createdAt 驗證（若存在）
          && (!('createdAt' in data.keys()) || data.createdAt == request.time)
          // deviceId 驗證（Rate Limiting 用）
          && (!('deviceId' in data.keys()) || (data.deviceId is string && data.deviceId.size() <= 64));
      }
    }

    match /roomSettings/{settingId} {
      // 所有人可讀取場地設定 (用以視覺化不開放時段)
      allow read: if true;
      // 僅限管理員可建立與更新
      allow write: if request.auth != null;
    }

    match /audit_logs/{logId} {
      // 允許任何人新增日誌 (包含未登入的使用者操作，如訪客嘗試登入失敗、自刪預約)
      allow create: if true;
      // 僅限管理員讀取日誌
      allow read: if request.auth != null;
      // 禁止修改與刪除日誌 (確保稽核完整性)
      allow update, delete: if false;
    }
  }
}
